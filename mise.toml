[tools]
opentofu = "1.10.2"
terragrunt = "0.82.3"
fd = "10.3.0"

[env]
PROJECT_NAME = "checkov-test"
PROJECT_VERSION = "1.0.0"

[tasks.checkov-plan]
description = "Use checkov to scan and check a terragrunt stack."
usage = '''
arg "env" "environment" default="development"
arg "region" "region" default="eu-central-1"
arg "stack" "terragrunt-stack" default="vpc"
'''
run = '''
#!/bin/bash -eux
WORKDIR=infrastructure/live/$usage_env/$usage_region/$usage_stack
TERRAGRUNT_CACHE=.terragrunt-stack/vpc/.terragrunt-cache

terragrunt init --all --working-dir $WORKDIR
terragrunt plan --all --working-dir $WORKDIR --out tfplan.binary

BINARY="$(fd -H -i tfplan.binary $WORKDIR/$TERRAGRUNT_CACHE)"
cd ./${BINARY%/*}
tofu show -json tfplan.binary | jq > tfplan.json

checkov -f tfplan.json
'''

[tasks.checkov-all]
description = "Use checkov to scan and check all terragrunt infrastructure."
run = '''
#!/bin/bash -eux
cd infrastructure

terragrunt init --all
terragrunt plan --all --out tfplan.binary

fd -HI -t f tfplan.binary | while read -r BINARY; do
  INFRA_DIR=$(pwd)
  cd $(dirname "$BINARY")
  tofu show -json tfplan.binary | jq > tfplan.json
  cd $INFRA_DIR
done

mkdir -p json-plans
INDEX=0
fd -HI -t f tfplan.json | while read -r JSON; do
  INDEX=$((INDEX + 1))
  mv "$JSON" "json-plans/tfplan$INDEX.json"
done

checkov -d json-plans
'''
